## Overview

By: _Charlie Calvert_

Learn how to write [Jest][jest] tests with the npm packaged called **create-react-app**.

A deck to accompany this assignment is here:

- [http://bit.ly/jest-cra](http://bit.ly/jest-cra)

This document has some sections in it not found in deck, so view both documents.

You need only follow the instructions found on the Deck from the first link above. You don't have to do the [ESLint](#eslint) and [ElfDebugEnzume.js](#elf-debug-enzyme) bits. Unless you want to. We will cover both of those subjects in class soon.</span></p>

## Install

**create-react-app** is probably already on your system in **~/npm/bin**. That directory should be on your path in the default Pristine Lubuntu system.

If **create-react-app** is not on your system, then install it like this:

```
npm install -g create-react-app
```

Make sure you are on the latest version:

    npm -g outdated

If any globally installed apps are outdated, then reinstall them:

    npm install -g create-react-app

## ENOSPC

When running tests, you may get an ENOSPC (Not Enough Space or something similar). Let's try to fix this problem up front. The explanation of what you need to do is here:

- [ENOSPC on Elvenware][enspc]

## Set the Default Port

Load your **.bashrc** file into an editor and add this line near the bottom of the file, if it is not already there:

```bash
export PORT=30025
```

Some of our programs will use this as the default PORT on which to run.

**NOTE**: _We might want to run some programs, especially Express programs, on some other port than 30025, such as 30026. Note that they will default to the port set in the manner described above. As a result, we will sometimes need to take steps to ensure they run on the port we want. One technique is to define the port in **package.json**:_

```JavaScript
"config": {
    "port": "30026"
},
```

Then in **www/bin**:

```javascript
const port = process.env.npm_package_config_port || 30026;
```

## Get Started

Switch to your Week01 branch.

- Navigate to the root of your repository
- Issue this command:
  - create-react-app **weekxx-react-jest**, where xx is the number of the current week of this quarter.
  - rename **weekxx-react-jest** to **Weekxx-React-Jest**
- Open up the project in WebStorm
- Set WebStorm to use JSX, React and ES6
  - File | Settings | Languages and Settings | JavaScript | React/JSX
- If you get lots of JsHint, EsLint or other errors, for now, just disable them:
  - File | Settings | Languages and Settings | JavaScript | Code Quality Tools Tools

## Running Tests

Open up **src/App.test.js**, shown below. This is a test that allows you to see if the syntax in **App.js** is good enough to allow the component to be loaded.

To run the tests, type: **npm test** in the project's root directory.

[Jest][jest] tests are in files with these extensions:

- *.test.js,
- *.spec.js
- or in a folder called **\_\_tests\_\_**
  - That's two underscores on either side of the word tests.

Here is the simple default test generated by **create-react-app**:

```javascript
import React from 'react';
import ReactDOM from 'react-dom';
import { App } from './App';

it('renders without crashing', () => {
   const div = document.createElement('div');
   ReactDOM.render(<App />, div);
});
```

This test is built with [Jest][jest] library, but the syntax looks just like the very popular Jasmine library. In most cases, it also behaves much like Jasmine.

## Writing Tests

Let's update the default example by wrapping the test in a **describe** method:

```javascript
import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';

describe('Jest Create React Tests', function () {

   it('renders without crashing', () => {
       const div = document.createElement('div');
       ReactDOM.render(<App />, div);
   });

});
```

[jest]: https://facebook.github.io/jest/

## Enzyme

We need a tool to capture and parse the output created by our React components. We test that output to see if it is valid. The tool that helps us do this is airbnb's Enzyme.

To install it run these commands:

```
npm install --save-dev enzyme react-test-renderer
npm install --save-dev enzyme-adapter-react-16
```

I believe we no longer need to use **react-addons-test-utils**

## Enzyme Test of Component Output

The updated tests shown below import **shallow** from enzyme. It grabs text from our component and then checks to see if the text is what we expect it to be.

```javascript
import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';
import Adapter from 'enzyme-adapter-react-16';
import { configure, shallow } from 'enzyme';
configure({ adapter: new Adapter() });

describe('jest test', function() {

   it('renders without crashing', () => {
       const div = document.createElement('div');
       ReactDOM.render(<App />, div);
       ReactDOM.unmountComponentAtNode(div);
   });

   it('renders and reads H1 text', () => {
       const wrapper = shallow(<App />);
       const welcome = <h1 className="App-title">Welcome to React</h1>;
       expect(wrapper.contains(welcome)).toEqual(true);
   });

});
```

Perhaps you are getting an error when you run these tests. You may be able to fix it by yourself, but let's learn how to use ElfDebugEnzyme to help you find the error.

**NOTE**: _**create-react-app** has recently changed the default code they put in **App.js**. Rather than trying to keep up with their changes, let's just check to make the h1 tag "Welcome to React" is in their **render** method. That might look a bit like this:_

```html
<header className="App-header">
  <h1 className="App-title">Welcome to React</h1>
  <img src={logo} className="App-logo" alt="logo" />
  <p>
    Edit <code>src/App.js</code> and save to reload.
  </p>
  <a
    className="App-link"
    href="https://reactjs.org"
    target="_blank"
    rel="noopener noreferrer"
  >
    Learn React
  </a>
</header>
```

What we are looking for is the H1 tag near the top of the JSX quoted above. Be sure you don't get tripped up over **H1** vs **H2** tag differences.

## Elf Debug Enzyme

Get a copy of my gist ElfDebugEnzyme and save it to a file with the same name (ElfDebugEnzyme.js):

- [Elf Debug Enzyme](http://bit.ly/elf-debug-enzyme)

**NOTE**: _The file is available via **get-gist**._

One way to save the file is to the choose the **Raw** button on GitHub, and then blockcopy the code. Now create a new file in WebStorm and paste in the code.

Now import **ElfDebugEnzyme** into your test:

```JavaScript
import ElfDebugEnzyme from '../ElfDebugEnzyme';

const elfDebugEnzyme = new ElfDebugEnzyme(true, 'App.test.js', true);
```

Use **ElfDebugEnzyme** to display the first H1 element:

```JavaScript
it('renders and reads H1 text', () => {
    const wrapper = shallow(<App />);
    const welcome = <h1 className="App-title">Welcome to React</h1>;
    elfDebugEnzyme.getFirst(wrapper, welcome.type, true);
    expect(wrapper.contains(welcome)).toEqual(true);
});
```

The key line is this one:

```JavaScript
elfDebugEnzyme.getFirst(wrapper, welcome.type, true);
```

First, note that in this case **welcome.type** will be **H1** because that is the type we are searching on. Thus the two following lines are equivalent:

```javascript
elfDebugEnzyme.getFirst(wrapper, welcome.type, true);
elfDebugEnzyme.getFirst(wrapper, 'h1', true);
```

But we prefer the first because it is DRYer. If you decide to search on an H2 instead of an H1, you need make the change in only one place.

The **elfDebugEnzyme** call is to its **getFirst** method. The code asks to see the contents of the first **H1** element generated by your React component. In our case, there is only one **H1** element, and it looks like this, when printed out by **ElfDebugEnzyme**:

```html
console.log src/ElfDebugEnzyme.js:66
  Caller: App.test.js:
  Debug value:
  <h1 className="App-title">
      Welcome to React
  </h1>
```

Lets review the use of **find.type**. When using **ElfDebugEnzyme** I have we don't need to hard code in the element we are searching. Instead, use **type**.

This code is not as good as it could be because we hard code in the type when calling the second parameter of **getFirst**:  

```javascript
const find = <button>Test Foo Route</button>;        
elfDebugEnzyme.getFirst(wrapper, 'button');
```

This is better because **find.type** is automatically set to **button**:

```javascript
const find = <button>Test Foo Route</button>;        
elfDebugEnzyme.getFirst(wrapper, find.type);
```

The big advantage is that **find.type** automatically picks up on changes to **find**. If you change **button** to **input** there would be no need to change the call to Enzyme:

```javascript
const find = <input>Test Foo Route</input>;        
elfDebugEnzyme.getFirst(wrapper, find.type);
```

If you pass in **false** to the last parameter of the constructor, then you get this output:

```javascript
console.log src/ElfDebugEnzyme.js:66
  Caller: App.test.js:
  Debug value:
  {
      "type": "h1",
      "key": null,
      "ref": null,
      "props": {
          "className": "App-title",
          "children": "Welcome to React"
      },
      "_owner": null,
      "_store": {}
  }
```

The relevant code in **ElfDebugEnzyme** is simple enough. It asks enzyme to find the first matching H1 element and display the **debug** information associated with that element:


```javascript
wrapper.find(element).first().debug();
```

Once you know the HTML that is being generated, you can adjust your test to ensure that it properly matches the HTML. Or vice versa, depending on your needs and circumstances.

Watch the [ElfDebugEnzyme video](https://youtu.be/JCfN8OgmKXA)

Watch a [second video](https://youtu.be/Z44pG1w-ZiU) documenting additional updates.

## Add a constructor and declare some state. {#constructor-state}

Once you know how to test for static HTML generated by your React component, then next step will be to test the dynamic code, the code that changes when you -- for instance -- press a button. Let's begin by adding a **constructor** to your React component.

The **constructor** is a function on your component. React calls is it before it mounts the component. Call super() first or else the this variable will not be valid in the constructor.

```javascript
class App extends Component {
   constructor() {
       super();
       this.state = {
           file: 'unknown'
       }
   }
… etc
}
```

React will keep your state variables up to date in your UI if you display and play by certain rules. In particular, when you change these variable, use **setState** as described later in this chapter.

## In render, display the state {#display-state}

In our JSX, we:

- declare a paragraph element,
- Style it not with **class**, but with the JSX **className** attribute
- Display our state in a react expression defined with curly braces.

```html
<p className="App-intro">File: {this.state.file}</p>
```

## Define a function called getFile {#define-getnine}

We declare an arrow function function in our component called **getFile**. Inside it, we call **setState**. The **setState** call can take an object literal defining the new state.

```javascript
getFile = () => {
    console.log('getFile called.');
    this.setState({file: 'url-file.js'})
};
```

## In render, display the state {#render-state}

In our JSX, we:

- Declare a button
- Give it **_not_** an HTML **onclick** attribute, but a JSX **onClick** attribute
- And use a react expression, defined with curly braces, to call **getNine** when the button is clicked.

```html
<button className='elf' onClick={this.getFile}>Get Nine</button>
```

## Test button click {#test-click}

It's time to write some unit tests with Jest.

Call the enzyme simulate method to simulate clicking the button. Check to see if the form now contains the value we expect it to contain. In other words, check that the button click method worked.

```javascript
it('renders button click message', () => {
   const wrapper = shallow(<App />);
   const nineSign = <p className="App-intro">File: url-file.js</p>;
   wrapper.find('button.elf').simulate('click');
   expect(wrapper.contains(nineSign)).toEqual(true);
});
```

To run only a single test use **it.only** or **fit**:

```javascript
it.only('renders button click message', () => {
   const wrapper = shallow(<App />);
   etc...   
})
```

With only:

```javascript
it.only('renders button click message', () => {
   const wrapper = shallow(<App />);
   etc...
})
```

**NOTE**: _When I write something like **etc...** or **and so on...** or **You write the code**, then I'm saying that I expect you to complete the code as an exercise. I usually cut and paste working code into a document like this, and then delete the parts I want readers to complete. I usually mark the missing code as described above._

## ESLint

Eslint should be installed globally in **~./npm/bin**.

Add this **.eslintrc.json** file to your project.

```JavaScript
{
    "extends": [
		"eslint:recommended",
		"plugin:react/recommended"
	],
    "rules": {
        // enable additional rules
        "indent": ["error", 4],
        "linebreak-style": ["error", "unix"],
        "quotes": ["warn", "single"],
        "semi": ["error", "always"],

        // override default options for rules from base configurations
        "comma-dangle": ["off", "always"],
        "no-cond-assign": ["error", "always"],

        // disable rules from base configurations
        "no-console": "off"
    },
    "parserOptions": {
        "ecmaVersion": 7,
        "sourceType": "module",
        "ecmaFeatures": {
            "jsx": true
        }
    },
    "env": {
        "browser": true,
        "node": true
    }
}
```

Run it like this:

```bash
eslint .
```
The code above sometimes needs to be updated. To see my current working **.eslintrc.json** file, go [here][eslintrc].

## Turn it in

Place your work in your repository if it is not already there. Merge your finished project into **master**.

Push your repository. Go to GitHub or BitBucket and ensure that the code you want to turn in is actually in your repository and that it contains the files and folders you expect it to contain.

Find the assignment on Canvas and submit it. Add text that states the name of the folder where you placed your assignment. A link to your folder on GitHub/Bitbucket is nice.

For most of the assignments, I'll just say something like: "Put your work in your repo and push," or simply "Push your work". That's a shorthand for something along the lines of what I'm saying here.

## Test Output

I'm expecting the test output to look something like this:

```javascript
PASS  src/App.test.js
 jest test
   ✓ renders without crashing (4ms)
   ✓ renders and reads H1 text (3ms)
   ✓ renders button click message (1ms)

Test Suites: 1 passed, 1 total
Tests:       3 passed, 3 total
Snapshots:   0 total
Time:        0.364s, estimated 1s
Ran all test suites.

 console.log ElfDebugEnzyme.js:45
   App.test.js:
   <h1 className="App-title">
     Welcome to React
   </h1>

 console.log src/App.js:14
   state

 console.log ElfDebugEnzyme.js:45
   App.test.js:
   App.test.js:
   <p className="App-intro">
     File:
     'url-file.js'
   </p>

```

## Hint

Don't nest folders! There should be only one folder called **Week02-ReactJest** in your repository. It should be in the root of your repository.

- Correct: my-repo/Week02-ReactJest
- Wrong: my-repo/Week02-ReactJest/Week02-ReactJest


## The warnings

You are probably no longer getting these warnings, but just in case I will include a few notes about warnings I received.

**Warning**: **ReactTestUtils** has been moved to **react-dom/test-utils**. Update references to remove this warning.
**Warning**: **Shallow renderer** has been moved to **react-test-renderer/shallow**. Update references to remove this warning

For awhile, I was seeing warnings due to outdated **react-addons-test-utils** and **enzyme** modules. I believe Enzyme has solved these issues. If you see the warnings below, try updating these two packages:

```
npm uninstall react-addons-test-utils enzyme
npm install react-addons-test-utils enzyme
```


[eslintrc]: https://gist.github.com/charliecalvert/c5952541925c04479150bbd8c40feac6
[enspc]: https://www.elvenware.com/javascript-guide/JavaScriptReact.html#enospc
