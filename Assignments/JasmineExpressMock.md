# Jasmine Express Mock

Learn about unit testing and mocks with Jasmine and **SpyOn**.

## Step One

Create our project using our script.

```bash
CreateExpressProject Week04-JasmineExpressMock
```

I maintain my copy of this script here:

**JsObjects/Utilities/NodeInstall/CreateExpressProject**

To get the most recent copy, navigate to the JsObjects folder and call **git pull**. You can then copy my version of the file into your bin directory. Alternatively, compare my version with yours:

```bash
meld $JSOBJECTS/Utilities/NodeInstall/CreateExpressProject ~/bin/CreateExpressProject
```

## Step Two: Set up Unit Testing {#unit-test-setup}

There are a number of steps you need to go through to properly configure you project for unit testing. In particular, we need to set up:

1. A test runner called **Karma**
* A build utility called **Grunt**
* A syntax checker called **JsHint**
* Set up our testing framework, which is called **Jasmine**
* Create a default unit test in a directory called **spec**

To prove that we have done the above steps correctly, we create a default test and run it.

**NOTE**: *Before going further, make sure you have installed **js-beautify**. This utility can help you properly format and indent your javascript files.*

```
npm install -g js-beautify
```

To complete the steps outlined above can use this script to set up Karam, Grunt and Jasmine:

```
#! /bin/bash

UNIT_TEST=$ELF_TEMPLATES/UnitTest

cp $ELF_TEMPLATES/Gruntfile.js .
cp $ELF_TEMPLATES/karma.conf.js .
sed -i '/\s\s}$/r '$ELF_TEMPLATES'/DevDependencies.json' package.json
js-beautify -r package.json 
sed -i "s/{$/{ 'use strict';/" routes/index.js
sed -i "s/{$/{ 'use strict';/" routes/users.js
sed -i "s/{$/{ 'use strict';/" app.js

npm install
mkdir spec
cp $UNIT_TEST/test-basic.js spec/.
```

The script first copies two files from ELF_TEMPLATES:

* Gruntfile.js: Configure Grunt.
* karama.conf.js: Configure Karma

It then adds a set of Grunt and Karma related packages to **package.json**. After the code is added, **package.json** is not very well formated and indented. To clean that up, we use **js-beautify**.

The next step is add **use strict** statments to several files that are auto-generated by express.

We then run **npm install**, and, as a final step, copy in a very simple unit test.

To confirm that everything is working, run **grunt test**. If you see output like the following, then all has gone well:

```
  Elvenware Simple Plain Suite
    âœ“ expects true to be true

PhantomJS 1.9.8 (Linux 0.0.0): Executed 1 of 1 SUCCESS (0.041 secs / 0.001 secs)
TOTAL: 1 SUCCESS
```

If you get errors related to **JsHint**


## Step Three
```javascript
/**
 * Created by charlie on 10/7/15.
 */

describe("Elvenware Simple Plain Suite", function() {

    'use strict';

    it("expects true to be true", function() {
        expect(true).toBe(true);
    });

});

describe("Elvenware Object Number Suite", function () {

    'use strict';



    it("Call a function in getNumber that returns 9", function () {
        expect(getNine()).toBe(9);
    });


    it("Test that we can parse the value expected to be returned from getJSON call", function() {
        var response = {nine: 10};
        bar.parseSimpleJson(response);
        expect(bar.value).toBe(10);
    });

    it("tests ajax call", function() {
        spyOn($, 'ajax').and.callFake(function (methods) {
            methods.success({"nine": 9});
        });
        bar.getAjaxServerNine();
        expect(bar.value).toBe(9);
    });

    it("tests getJSON call", function() {
        spyOn($, 'getJSON').and.callFake(function (url, success) {
            success({"nine": 9});
        });
        bar.getJsonServerNine();
        expect(bar.value).toBe(9);
    });
});

```


## Step Three

Gruntfile

```javascript
module.exports = function(grunt) {
	'use strict';

	grunt.initConfig({

		pkg : '<json:package.json>',

		karma : {
			karma : {
				configFile : 'karma.conf.js'
			}
		},

		jshint : {
			files : [ '**/*.js' ],

			options : {
				ignores : [ 
				     '**/node_modules/**', '**/components/**'
				],
				reporter : 'checkstyle',
				reporterOutput : 'result.xml',
				strict : true,
				globals : {
					describe : true,
					afterEach : true,
					beforeEach : true,
					inject : true,
					it : true,
					jasmine : true,
					expect : true
				}
			}
		},

	});

	grunt.loadNpmTasks('grunt-karma');
	grunt.loadNpmTasks('grunt-contrib-jshint');
	grunt.registerTask('test', [ 'jshint', 'karma' ]);

};

```

kama config

```javascript
/* global process: true */

module.exports = function(config) {
    'use strict';
    
    config.set({
        // base path, that will be used to resolve files and exclude
        basePath: './',

        frameworks: ['jasmine'],
        
        files: [
            'public/components/jquery/dist/jquery.min.js',
            'public/javascripts/*.js',
            'spec/test*.js'
        ],

        // list of files to exclude
        exclude: [
        ],

        reporters: ['spec'],

        // web server port
        port: 9876,

        // enable / disable colors in the output (reporters and logs)
        colors: true,

        // level of logging
        logLevel: config.LOG_INFO,

        // enable / disable watching file and executing tests whenever any file changes
        // CLI --auto-watch --no-auto-watch
        autoWatch: true,

        // Start these browsers, currently available:
        browsers: ['PhantomJS'],

        // If browser does not capture in given timeout [ms], kill it
        captureTimeout: 20000,

        // Set to false to watch files for changes
        singleRun: true,

        plugins: ["karma-jasmine",
            "karma-spec-reporter",
            'karma-phantomjs-launcher']

    });
};
```